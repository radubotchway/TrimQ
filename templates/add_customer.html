{% extends "base.html" %}

{% block content %}
<div class="row justify-content-between align-items-center mb-4">
    <div class="col">
        <h2 class="fw-bold">
            <i class="bi bi-person-plus"></i> Add Customer - {{ branch_info.name }}
        </h2>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('queue_manage', branch_code=branch_code) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Queue
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Customer Information</h4>
            </div>
            <div class="card-body p-4">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.name.label(class="form-label fw-semibold") }}
                            {{ form.name(class="form-control form-control-lg") }}
                        </div>
                        <div class="col-md-6">
                            {{ form.phone.label(class="form-label fw-semibold") }}
                            {{ form.phone(class="form-control form-control-lg") }}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        {{ form.service_id.label(class="form-label fw-semibold") }}
                        {{ form.service_id(class="form-select form-select-lg") }}
                        <div class="form-text">Prices are in Ghana Cedis (GH‚Çµ)</div>
                    </div>
                    
                    <div class="mb-4">
                        {{ form.notes.label(class="form-label fw-semibold") }}
                        {{ form.notes(class="form-control") }}
                    </div>
                    
                    <!-- Ticket Generation Option -->
                    <div class="mb-4">
                        <div class="card bg-light border-primary">
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input form-check-input-lg" type="checkbox" 
                                           id="print_ticket" name="print_ticket" value="1" checked>
                                    <label class="form-check-label fw-semibold" for="print_ticket">
                                        üé´ Generate Printable Ticket
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="bi bi-info-circle"></i> 
                                    When enabled, a printable ticket will be generated for the customer with their queue number and estimated wait time.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-ghana btn-lg") }}
                    </div>
                </form>
            </div>
        </div>

        <!-- Ticket Preview Card -->
        <div class="card mt-4" id="ticketPreview" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-eye"></i> Ticket Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="ticket-preview-container" style="max-width: 300px; margin: 0 auto;">
                    <div class="mini-ticket" style="background: linear-gradient(135deg, #006b3c 0%, #2563eb 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 10px;">
                        <div style="height: 2px; background: linear-gradient(to right, #ce1126 33%, #ffd700 33%, #ffd700 66%, #006b3c 66%); margin-bottom: 10px;"></div>
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">‚úÇÔ∏è</div>
                        <div style="font-weight: 700;">TrimQ Ticket</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">{{ branch_info.name }}</div>
                    </div>
                    <div style="background: white; border: 2px dashed #dee2e6; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: #2563eb; margin-bottom: 10px;">
                            TICKET #<span id="previewTicketNumber">XXXX-XXXX</span>
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Customer will receive queue position, wait time, and service details
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="bi bi-printer"></i> 
                        Customer can print this ticket after being added to the queue
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const printTicketCheckbox = document.getElementById('print_ticket');
    const ticketPreview = document.getElementById('ticketPreview');
    
    // Show/hide ticket preview based on checkbox
    function toggleTicketPreview() {
        if (printTicketCheckbox.checked) {
            ticketPreview.style.display = 'block';
            ticketPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            ticketPreview.style.display = 'none';
        }
    }
    
    // Initial state
    toggleTicketPreview();
    
    // Listen for checkbox changes
    printTicketCheckbox.addEventListener('change', toggleTicketPreview);
    
    // Update preview ticket number based on current date/time
    function updatePreviewTicketNumber() {
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const branchCode = '{{ branch_code }}'.toUpperCase();
        const previewNumber = `${branchCode}-${month}${day}-XXXX`;
        document.getElementById('previewTicketNumber').textContent = previewNumber;
    }
    
    // Initialize preview
    updatePreviewTicketNumber();
    
    // Form validation enhancement
    const form = document.querySelector('form');
    const nameInput = document.querySelector('input[name="name"]');
    const phoneInput = document.querySelector('input[name="phone"]');
    const serviceSelect = document.querySelector('select[name="service_id"]');
    
    // Real-time validation feedback
    function validateForm() {
        let isValid = true;
        
        // Validate name
        if (nameInput.value.trim().length < 2) {
            nameInput.classList.add('is-invalid');
            isValid = false;
        } else {
            nameInput.classList.remove('is-invalid');
            nameInput.classList.add('is-valid');
        }
        
        // Validate phone (basic Ghana phone number format)
        const phonePattern = /^(\+233|0)(2[0-9]|5[0-9]|24|54|27|57|26|56)[0-9]{7}$/;
        if (!phonePattern.test(phoneInput.value.replace(/\s+/g, ''))) {
            phoneInput.classList.add('is-invalid');
            isValid = false;
        } else {
            phoneInput.classList.remove('is-invalid');
            phoneInput.classList.add('is-valid');
        }
        
        // Validate service selection
        if (!serviceSelect.value) {
            serviceSelect.classList.add('is-invalid');
            isValid = false;
        } else {
            serviceSelect.classList.remove('is-invalid');
            serviceSelect.classList.add('is-valid');
        }
        
        return isValid;
    }
    
    // Add validation listeners
    nameInput.addEventListener('input', validateForm);
    phoneInput.addEventListener('input', validateForm);
    serviceSelect.addEventListener('change', validateForm);
    
    // Form submission with loading state
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return;
        }
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding Customer...';
        submitBtn.disabled = true;
        
        // Re-enable if form submission fails
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });
    
    // Auto-format phone number
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // Handle Ghana phone number formatting
        if (value.startsWith('233')) {
            value = '+' + value.slice(0, 12);
        } else if (value.startsWith('0')) {
            value = value.slice(0, 10);
        }
        
        e.target.value = value;
    });
    
    // Service selection enhancement
    serviceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            // Extract price from option text for preview
            const optionText = selectedOption.text;
            const priceMatch = optionText.match(/GH‚Çµ(\d+)/);
            if (priceMatch) {
                console.log('Selected service price: GH‚Çµ' + priceMatch[1]);
            }
        }
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt + T: Toggle ticket option
    if (e.altKey && e.key === 't') {
        e.preventDefault();
        const checkbox = document.getElementById('print_ticket');
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
    }
    
    // Alt + S: Focus on service select
    if (e.altKey && e.key === 's') {
        e.preventDefault();
        document.querySelector('select[name="service_id"]').focus();
    }
});
</script>

<style>
/* Enhanced form styles */
.form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.4.4c.4.4.8.4 1.2 0l2.8-2.8c.4-.4.4-.8 0-1.2s-.8-.4-1.2 0L3.7 5 2.6 3.9c-.4-.4-.8-.4-1.2 0s-.4.8 0 1.2l.9.6z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4M8.2 4.6l-2.4 2.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-select.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.4.4c.4.4.8.4 1.2 0l2.8-2.8c.4-.4.4-.8 0-1.2s-.8-.4-1.2 0L3.7 5 2.6 3.9c-.4-.4-.8-.4-1.2 0s-.4.8 0 1.2l.9.6z'/%3e%3c/svg%3e"), url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    background-position: right calc(0.375em + 0.1875rem) center, right 0.75rem center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem), 16px 12px;
}

.form-select.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4M8.2 4.6l-2.4 2.4'/%3e%3c/svg%3e"), url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    background-position: right calc(0.375em + 0.1875rem) center, right 0.75rem center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem), 16px 12px;
}

/* Ticket preview animation */
#ticketPreview {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Form switch enhancement */
.form-check-input-lg {
    width: 2.5rem;
    height: 1.25rem;
}

.form-check-input-lg:checked {
    background-color: var(--ghana-green);
    border-color: var(--ghana-green);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .ticket-preview-container {
        max-width: 250px !important;
    }
    
    .mini-ticket {
        padding: 10px !important;
    }
}
</style>
{% endblock %}