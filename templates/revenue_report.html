{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">
        <i class="bi bi-graph-up"></i> Revenue Reports
        {% if not current_user.is_master_admin() %}
            - {{ BRANCHES[current_user.branch].name }}
        {% endif %}
    </h2>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" onclick="window.print()">
            <i class="bi bi-printer"></i> Print Report
        </button>
        <button type="button" class="btn btn-outline-success" onclick="exportToCSV()">
            <i class="bi bi-file-earmark-excel"></i> Export CSV
        </button>
    </div>
</div>

<!-- Date Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="d-flex align-items-end gap-3">
                    <div class="flex-grow-1">
                        <label class="form-label fw-semibold">Report Date</label>
                        <input type="date" name="date" class="form-control" 
                               value="{{ report_date.isoformat() }}" 
                               max="{{ today.strftime('%Y-%m-%d') }}">
                    </div>
                    <button type="submit" class="btn btn-barbers">
                        <i class="bi bi-search"></i> View Report
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3 class="mb-1">{{ report_date.strftime('%B %d, %Y') }}</h3>
                <p class="mb-0">{{ report_date.strftime('%A') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="stat-card border-success">
            <div class="stat-number text-success">GH₵{{ "%.2f"|format(total_revenue) }}</div>
            <h6 class="text-muted mb-0">Total Revenue</h6>
            <small class="text-success">
                <i class="bi bi-cash-stack"></i> 
                {% if total_customers > 0 %}
                    Avg: GH₵{{ "%.2f"|format(total_revenue / total_customers) }} per customer
                {% endif %}
            </small>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card border-info">
            <div class="stat-number text-info">{{ total_customers }}</div>
            <h6 class="text-muted mb-0">Customers Served</h6>
            <small class="text-info">
                <i class="bi bi-people"></i> Completed services
            </small>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="stat-card border-warning">
            <div class="stat-number text-warning">
                {% if current_user.is_master_admin() %}
                    {{ revenue_data|length }}
                {% else %}
                    {% if revenue_data %}{{ revenue_data[0].total_customers }}{% else %}0{% endif %}
                {% endif %}
            </div>
            <h6 class="text-muted mb-0">
                {% if current_user.is_master_admin() %}
                    Active Branches
                {% else %}
                    Branch Total
                {% endif %}
            </h6>
            <small class="text-warning">
                <i class="bi bi-shop"></i> 
                {% if current_user.is_master_admin() %}
                    Revenue generating locations
                {% else %}
                    {{ BRANCHES[current_user.branch].name }}
                {% endif %}
            </small>
        </div>
    </div>
</div>

<!-- Revenue Breakdown -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="barbers-flag"></div>
                <h4 class="mb-0 text-white">
                    <i class="bi bi-table"></i> 
                    {% if current_user.is_master_admin() %}
                        Franchise Revenue Breakdown
                    {% else %}
                        Branch Revenue Details
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                {% if revenue_data %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="revenueTable">
                            <thead class="table-dark">
                                <tr>
                                    {% if current_user.is_master_admin() %}
                                        <th><i class="bi bi-shop"></i> Branch</th>
                                        <th><i class="bi bi-geo-alt"></i> Location</th>
                                    {% endif %}
                                    <th><i class="bi bi-cash-coin"></i> Revenue</th>
                                    <th><i class="bi bi-people"></i> Customers</th>
                                    <th><i class="bi bi-calculator"></i> Avg per Customer</th>
                                    <th><i class="bi bi-percent"></i> Contribution</th>
                                    <th><i class="bi bi-clock"></i> Last Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in revenue_data %}
                                    <tr>
                                        {% if current_user.is_master_admin() %}
                                            <td>
                                                <strong>{{ branches_dict.get(record.branch, {}).get('name', record.branch) }}</strong>
                                                <br>
                                                <small class="text-muted">{{ record.branch }}</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="bi bi-geo-alt"></i> 
                                                    {{ branches_dict.get(record.branch, {}).get('address', 'N/A') }}
                                                    <br>
                                                    <i class="bi bi-telephone"></i> 
                                                    {{ branches_dict.get(record.branch, {}).get('phone', 'N/A') }}
                                                </small>
                                            </td>
                                        {% endif %}
                                        <td>
                                            <span class="revenue-badge">
                                                GH₵{{ "%.2f"|format(record.total_revenue) }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ record.total_customers }}</span>
                                        </td>
                                        <td>
                                            {% if record.total_customers > 0 %}
                                                <span class="currency">
                                                    GH₵{{ "%.2f"|format(record.total_revenue / record.total_customers) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if total_revenue > 0 %}
                                                <div class="progress" style="height: 20px;">
                                                    {% set percentage = (record.total_revenue / total_revenue * 100) %}
                                                    <div class="progress-bar bg-success" 
                                                         style="width: {{ percentage }}%"
                                                         title="{{ "%.1f"|format(percentage) }}%">
                                                        {{ "%.1f"|format(percentage) }}%
                                                    </div>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">0%</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ record.updated_at.strftime('%H:%M:%S') }}
                                            </small>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            {% if current_user.is_master_admin() and revenue_data|length > 1 %}
                                <tfoot class="table-secondary">
                                    <tr>
                                        <td colspan="2"><strong>TOTAL</strong></td>
                                        <td><strong class="text-success">GH₵{{ "%.2f"|format(total_revenue) }}</strong></td>
                                        <td><strong class="text-info">{{ total_customers }}</strong></td>
                                        <td>
                                            {% if total_customers > 0 %}
                                                <strong class="currency">GH₵{{ "%.2f"|format(total_revenue / total_customers) }}</strong>
                                            {% else %}
                                                <strong class="text-muted">N/A</strong>
                                            {% endif %}
                                        </td>
                                        <td><strong>100%</strong></td>
                                        <td>-</td>
                                    </tr>
                                </tfoot>
                            {% endif %}
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-graph-down display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">No Revenue Data</h5>
                        <p class="text-muted">
                            No completed services found for {{ report_date.strftime('%B %d, %Y') }}
                        </p>
                        <a href="{{ url_for('add_customer', branch_code=current_user.branch if not current_user.is_master_admin() else 'main') }}" 
                           class="btn btn-barbers">
                            <i class="bi bi-person-plus"></i> Start Adding Customers
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Date Navigation -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-2">Quick Date Navigation</h6>
                        <div class="btn-group" role="group">
                            <a href="?date={{ (report_date - timedelta(days=1)).isoformat() }}" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-chevron-left"></i> Previous Day
                            </a>
                            <a href="?date={{ today.strftime('%Y-%m-%d') }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-calendar-today"></i> Today
                            </a>
                            {% if report_date < today %}
                                <a href="?date={{ (report_date + timedelta(days=1)).isoformat() }}" 
                                   class="btn btn-outline-secondary btn-sm">
                                    Next Day <i class="bi bi-chevron-right"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Revenue updates in real-time as services are completed
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Insights (for Master Admin) -->
{% if current_user.is_master_admin() and revenue_data %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-trophy"></i> Top Performing Branch
                </h5>
            </div>
            <div class="card-body">
                {% set top_branch = revenue_data | sort(attribute='total_revenue', reverse=true) | first %}
                <div class="text-center">
                    <h3 class="text-info">{{ branches_dict.get(top_branch.branch, {}).get('name', top_branch.branch) }}</h3>
                    <p class="text-muted">{{ branches_dict.get(top_branch.branch, {}).get('address', '') }}</p>
                    <div class="revenue-badge">GH₵{{ "%.2f"|format(top_branch.total_revenue) }}</div>
                    <small class="text-muted d-block mt-2">
                        {{ top_branch.total_customers }} customers served
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i> Performance Summary
                </h5>
            </div>
            <div class="card-body">
                {% set avg_revenue = total_revenue / revenue_data|length if revenue_data|length > 0 else 0 %}
                {% set avg_customers = total_customers / revenue_data|length if revenue_data|length > 0 else 0 %}
                
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">GH₵{{ "%.2f"|format(avg_revenue) }}</h4>
                        <small class="text-muted">Avg Revenue per Branch</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">{{ "%.1f"|format(avg_customers) }}</h4>
                        <small class="text-muted">Avg Customers per Branch</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-buildings"></i> 
                        {{ revenue_data|length }} active branches today
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Export to CSV functionality
function exportToCSV() {
    const table = document.getElementById('revenueTable');
    if (!table) {
        alert('No data to export');
        return;
    }
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    // Process each row
    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].querySelectorAll('td, th');
        let row = [];
        
        for (let j = 0; j < cells.length; j++) {
            let cellText = cells[j].textContent.trim();
            // Clean up the text (remove extra whitespace and icons)
            cellText = cellText.replace(/\s+/g, ' ').replace(/[^\w\s.,₵%-]/g, '');
            row.push('"' + cellText + '"');
        }
        
        csv.push(row.join(','));
    }
    
    // Create and download the file
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    const date = '{{ report_date.isoformat() }}';
    const filename = `revenue-report-${date}.csv`;
    
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print-specific styles
const printStyles = `
    @media print {
        .btn, .card-header, .navbar, .quick-actions { display: none !important; }
        .card { border: 1px solid #000 !important; box-shadow: none !important; }
        .table { font-size: 12px; }
        .stat-card { border: 1px solid #000; margin-bottom: 10px; }
        body { background: white !important; }
        .revenue-badge { background: #000 !important; color: white !important; }
    }
`;

// Add print styles to head
const styleSheet = document.createElement('style');
styleSheet.textContent = printStyles;
document.head.appendChild(styleSheet);

// Auto-refresh every 5 minutes
setInterval(() => {
    const currentDate = new URLSearchParams(window.location.search).get('date');
    const today = new Date().toISOString().split('T')[0];
    
    // Only auto-refresh if viewing today's data
    if (!currentDate || currentDate === today) {
        window.location.reload();
    }
}, 300000); // 5 minutes

// Enhance progress bars with animation
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar');
    
    progressBars.forEach((bar, index) => {
        const width = bar.style.width;
        bar.style.width = '0%';
        
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, index * 200);
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Alt + P: Print
    if (e.altKey && e.key === 'p') {
        e.preventDefault();
        window.print();
    }
    
    // Alt + E: Export CSV
    if (e.altKey && e.key === 'e') {
        e.preventDefault();
        exportToCSV();
    }
    
    // Alt + T: Go to today
    if (e.altKey && e.key === 't') {
        e.preventDefault();
        window.location.href = '?date={{ today.strftime("%Y-%m-%d") }}';
    }
});

// Tooltip for progress bars
document.querySelectorAll('.progress-bar').forEach(bar => {
    new bootstrap.Tooltip(bar, {
        placement: 'top'
    });
});
</script>

<style>
/* Custom styles for revenue report */
.revenue-table {
    font-family: 'Poppins', sans-serif;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.8rem;
}

.stat-card .stat-number {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
}

.table th {
    border-top: none;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    color: white;
}

.table-hover tbody tr:hover {
    background-color: rgba(139, 0, 0, 0.05);
}

.revenue-highlight {
    background: linear-gradient(135deg, rgba(139, 0, 0, 0.1) 0%, rgba(220, 20, 60, 0.1) 100%);
    padding: 0.5rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

/* Print styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    .card {
        break-inside: avoid;
        margin-bottom: 1rem;
    }
    
    .table {
        font-size: 10px;
    }
    
    .stat-card {
        border: 2px solid #000;
        margin-bottom: 1rem;
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .stat-number {
        font-size: 2rem !important;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .progress {
        height: 15px;
    }
    
    .progress-bar {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}